## 项目数据结构与接口格式总结

### 1. MySQL 表结构

#### 1.1 user 表（用户信息表）

```mysql
CREATE TABLE `user` ( 
    `uid` INT NOT NULL COMMENT '用户ID，主键', 
    `name` VARCHAR(50) NOT NULL COMMENT '用户名',
    `email` VARCHAR(100) NOT NULL COMMENT '邮箱地址',
    `pwd` VARCHAR(255) NOT NULL COMMENT '密码哈希值', 
    `create_time` BIGINT DEFAULT NULL COMMENT '创建时间（Unix时间戳）', 
    `last_login_time` BIGINT DEFAULT NULL COMMENT '最后登录时间（Unix时间戳）',
    PRIMARY KEY (`uid`),
    UNIQUE KEY `uk_name` (`name`),
    UNIQUE KEY `uk_email` (`email`), 
    KEY `idx_name` (`name`),
    KEY `idx_email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户信息表';
```



#### 1.2 user_id 表（用户ID自增表）

```mysql
CREATE TABLE `user_id` (
    `id` INT NOT NULL DEFAULT 0 COMMENT '当前最大用户ID', PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户ID自增表';

初始化：INSERT INTO user_id (id) VALUES (10000);
```



------

### 2. Redis 键值结构

#### 2.1 验证码键

- 键格式：code_<email>

- 示例：code_user@example.com

- 用途：存储邮箱验证码

- 过期时间：默认 300 秒（5分钟）

#### 2.2 Token 键

- 键格式：token_<uid>

- 示例：token_10001

- 用途：存储用户登录 Token

- 过期时间：默认 7200 秒（2小时）

------

### 3. HTTP 接口格式

#### 3.1 统一响应格式

成功响应（无数据）：

```json
{
 "success": 1,
 "code": 0,
 "msg": "操作成功",
 "timestamp": 1234567890
}
```

成功响应（带数据）：

```json
{
 "success": 1,
 "code": 0,
 "msg": "操作成功",
 "data": {
  // 具体数据*
 },
 "timestamp": 1234567890
}
```

错误响应：

```json
{
 "success": 0,
 "code": 1001,
 "msg": "错误信息",
 "timestamp": 1234567890
}
```

#### 3.2 具体接口

##### 3.2.1 获取验证码

- 请求：POST /api/verify/code

- 请求体：

  ```json
  {
   "email": "user@example.com"
  }
  ```

  

- 响应：统一响应格式

##### 3.2.2 用户注册

- 请求：POST /api/user/register

- 请求体：

  ```json
  {
   "username": "testuser",
   "email": "user@example.com",
   "password": "password123",
   "code": "123456"
  }
  ```

- 响应：统一响应格式

##### 3.2.3 用户登录

- 请求：POST /api/user/login

- 请求体：

  ```json
  {
   "email": "user@example.com",
   "password": "password123"
  }
  ```

  

- 成功响应：

  ```json
  {
     "success": 1,
     "code": 0,
     "msg": "Login successful",
     "data": 
      {
      "token": "xxx",
      "uid": 10001,
      "username": "testuser",
      "email": "user@example.com",
      "host": "192.168.1.100",
      "port": 8888
   	},
     "timestamp": 1234567890
  }
  ```

  

##### 3.2.4 重置密码

- 请求：POST /api/user/resetPassword

- 请求体：

  ```json
  {
   "email": "user@example.com",
   "newPassword": "newpassword123",
   "code": "123456"
  }
  ```

  

- 响应：统一响应格式

------

### 4. gRPC 接口格式

#### 4.1 Protobuf 定义（message.proto）

syntax = "proto3";

```protobuf
package message;

// 验证码服务

service VerifyService {
 rpc GetVerifyCode (GetVerifyRequest) returns (GetVerifyResponse) {}
}

message GetVerifyRequest {
 string email = 1;
}

message GetVerifyResponse {
 int32 error = 1;   // 错误码：0=成功，其他=失败
 string email = 2;
 string code = 3;
}

// 状态服务

service StatusService {
 rpc GetChatServer (GetChatServerRequest) returns (GetChatServerResponse) {}
}

message GetChatServerRequest {
 int32 uid = 1;
}

message GetChatServerResponse {
 int32 error = 1;   // 错误码：0=成功，其他=失败
 string host = 2;   // 聊天服务器IP
 string port = 3;   // 聊天服务器端口
 string token = 4;   // 认证Token
}
```



#### 4.2 gRPC 错误码（GrpcErrors）

- ```c++
  - Success = 10000：成功
  - RedisError = 10001：Redis 错误
  - EmailError = 10002：邮件发送错误
  - Exception = 10003：异常
  - Timeout = 10004：超时
  ```

  

------

### 5. HTTP 错误码（ServerStatus::ErrorCodes）

- ```c++
  - Success = 0：成功
  - Error_Json = 1001：JSON 解析错误
  - RPCFailed = 1002：RPC 请求错误
  - VarifyExpired = 1003：验证码过期
  - VarifyCodeErr = 1004：验证码错误
  - UserExist = 1005：用户已存在
  - PasswdInValid = 1006：密码无效
  - PasswdErr = 1007：密码错误
  - EmailNotMatch = 1008：邮箱不匹配
  - ResetPassFailed = 1009：更新密码失败
  - NewPassIsSame = 1010：两次密码相同
  - TokenInvalid = 1011：Token 失效
  - UidInvalid = 1012：uid 无效
  - UserNotFound = 1015：用户不存在
  - InternalError = 1101：HTTP 内部错误
  - ParamError = 1102：参数错误
  ```

  